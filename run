#!/usr/bin/env bash

# This script MIRRORS the 'dev-env' logic from your previous repo.
# It DESTRUCTIVELY wipes the target directory and replaces it with the one from the repo.

set -e

REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
CONFIGS_DIR="$REPO_ROOT/configs"

# Text Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m'

log() {
    echo -e "${BLUE}[DEPLOY]${NC} $1"
}

warn() {
    echo -e "${RED}[WARNING]${NC} $1"
}

deploy_dir() {
    local source_dir="$1"
    local target_parent="$2"
    
    if [ ! -d "$source_dir" ]; then
        return
    fi

    # Loop through direct children (directories)
    for item in "$source_dir"/*; do
        local name=$(basename "$item")
        local target_path="$target_parent/$name"

        if [ -d "$item" ]; then
            log "Config: $name"
            if [ -d "$target_path" ]; then
                 # echo "  Removing existing: $target_path"
                 rm -rf "$target_path"
            fi
            
            # echo "  Copying to: $target_path"
            mkdir -p "$(dirname "$target_path")"
            cp -r "$item" "$target_path"
        fi
    done
}

deploy_file() {
    local source_file="$1"
    local target_file="$2"
    
    if [ -f "$source_file" ]; then
        log "File: $(basename "$source_file")"
        rm -f "$target_file"
        cp "$source_file" "$target_file"
    fi
}

echo "========================================"
echo "      DEPLOYING CONFIGS (COPY MODE)     "
echo "========================================"
echo "Source: $CONFIGS_DIR"
echo "Target: $HOME"
echo ""

# 1. Deploy .config folders (e.g. nvim, hypr, kitty)
#    This wipes ~/.config/nvim and replaces it with configs/.config/nvim
deploy_dir "$CONFIGS_DIR/.config" "$HOME/.config"

# 2. Deploy .local folders (e.g. scripts)
#    This wipes ~/.local/scripts and replaces it with configs/.local/scripts
deploy_dir "$CONFIGS_DIR/.local" "$HOME/.local"

# 3. Deploy loose dotfiles
#    You must manually add files here if you want them copied
deploy_file "$CONFIGS_DIR/.zshrc" "$HOME/.zshrc"
# deploy_file "$CONFIGS_DIR/.xprofile" "$HOME/.xprofile"

echo ""
echo -e "${GREEN}Done!${NC}"
