#!/usr/bin/env bash
set -e

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" &>/dev/null && pwd)"
CONFIGS_DIR="$script_dir/configs"

dry_run="0"
grep_filter=""

# parse arguments
while [[ $# -gt 0 ]]; do
  if [[ "$1" == "--dry" ]]; then
    dry_run="1"
  else
    grep_filter="$1"
  fi
  shift
done

log() {
  if [[ $dry_run == "1" ]]; then
    echo "[DRY_RUN]: $1"
  else
    echo "$1"
  fi
}

warn() {
  log "[WARNING] $1"
}

info() {
  log "[INFO] $1"
}

deploy_dir() {
  local source_dir="$1"
  local target_parent="$2"

  if [ ! -d "$source_dir" ]; then
    info "Source directory $source_dir does not exist, skipping."
    return
  fi

  shopt -s nullglob
  for item in "$source_dir"/*; do
    local name="$(basename "$item")"
    local target_path="$target_parent/$name"

    if [[ -n "$grep_filter" && "$name" != *"$grep_filter"* ]]; then
      info "Filtered out $item by grep \"$grep_filter\""
      continue
    fi

    if [ -d "$item" ]; then
      log "Deploying directory: $item → $target_path"
      if [ -d "$target_path" ]; then
        warn "Removing existing: $target_path"
        [[ $dry_run == "0" ]] && rm -rf "$target_path"
      fi
      [[ $dry_run == "0" ]] && mkdir -p "$target_parent"
      log "Copying: $item → $target_path"
      [[ $dry_run == "0" ]] && cp -a "$item" "$target_path" || info "[DRY_RUN]: skipped copy"
    elif [ -f "$item" ]; then
      log "Deploying file: $item → $target_path"
      [[ $dry_run == "0" ]] && mkdir -p "$(dirname "$target_path")"
      [[ $dry_run == "0" ]] && cp "$item" "$target_path" || info "[DRY_RUN]: skipped copy"
    else
      warn "Skipping unknown item type: $item"
    fi
  done
  shopt -u nullglob
}

deploy_file() {
  local source_file="$1"
  local target_file="$2"

  if [[ -f "$source_file" ]]; then
    log "Deploying file: $source_file → $target_file"
    [[ $dry_run == "0" ]] && mkdir -p "$(dirname "$target_file")"
    [[ $dry_run == "0" ]] && cp "$source_file" "$target_file" || info "[DRY_RUN]: skipped copy"
  else
    info "File $source_file not found, skipping."
  fi
}

echo "========================================"
echo "      DEPLOYING CONFIGS (COPY MODE)     "
echo "========================================"
echo "Source: $CONFIGS_DIR"
echo "Target: $HOME"
echo ""

# 1. Deploy .config folders
deploy_dir "$CONFIGS_DIR/.config" "$HOME/.config"

# 2. Deploy .local folders
deploy_dir "$CONFIGS_DIR/.local" "$HOME/.local"

# 3. Deploy loose dotfiles
deploy_file "$CONFIGS_DIR/.zshrc" "$HOME/.zshrc"
# deploy_file "$CONFIGS_DIR/.xprofile" "$HOME/.xprofile"

echo ""
log "Reloading hyprland..."
if command -v hyprctl >/dev/null 2>&1; then
  [[ $dry_run == "0" ]] && hyprctl reload
  log "Hyprland reloaded"
else
  warn "hyprctl not found, skipping reload"
fi

echo ""
log "Done!"
